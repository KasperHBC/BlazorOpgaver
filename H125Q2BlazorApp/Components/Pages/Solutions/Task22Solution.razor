@page "/solutions/22"
@rendermode InteractiveServer
@inject NavigationManager NavigationManager
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthStateProvider
@using System.Security.Claims

<PageTitle>Implementering: Min profil-kort</PageTitle>

<h1>Implementering: Min profil-kort</h1>

<div class="alert alert-info mb-4">
    <h4>Opgaveinfo</h4>
    <p>Denne opgave demonstrerer hvordan man kan bruge AuthenticationStateProvider til at få information om den indloggede bruger og vise relevante data baseret på brugerens claims.</p>
</div>

<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="m-0">Min Profil</h5>
    </div>
    <div class="card-body">
        @if (isLoading)
        {
            <div class="d-flex justify-content-center my-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Indlæser...</span>
                </div>
            </div>
        }
        else if (isAuthenticated)
        {
            <div class="row">
                <div class="col-md-8 offset-md-2">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center p-4">
                            <div class="mb-4">
                                <div class="avatar-circle bg-primary mx-auto mb-3">
                                    <span class="avatar-initials">@GetInitials(userName)</span>
                                </div>
                                <h2 class="mb-0">@userName</h2>
                                <p class="text-muted">@userEmail</p>
                            </div>
                            
                            <div class="border-top pt-3">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <h6 class="text-muted">Oprettet</h6>
                                        <p>@(creationDate.HasValue ? creationDate.Value.ToString("d. MMMM yyyy") : "Ikke tilgængelig")</p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <h6 class="text-muted">Bruger ID</h6>
                                        <p>@userId</p>
                                    </div>
                                </div>
                            </div>
                            
                            @if (userRoles.Any())
                            {
                                <div class="border-top pt-3">
                                    <h6 class="text-muted mb-3">Roller</h6>
                                    <div class="d-flex flex-wrap justify-content-center gap-2">
                                        @foreach (var role in userRoles)
                                        {
                                            <span class="badge bg-secondary">@role</span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-warning">
                <h5 class="alert-heading">Ikke logget ind</h5>
                <p>Du er ikke logget ind. Log ind for at se din profilinformation.</p>
                <hr>
                <p class="mb-0">Denne komponent bruger AuthenticationStateProvider til at kontrollere om du er autentificeret og vise dine brugerdata.</p>
                <button class="btn btn-primary mt-3" @onclick="SimulateLogin">Simuler Login</button>
            </div>
        }
    </div>
</div>

<div class="mt-4">
    <button class="btn btn-primary" @onclick="GoBack">Tilbage til detaljer</button>
</div>

<style>
    .avatar-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
    }
    
    .avatar-initials {
        font-size: 32px;
        font-weight: bold;
    }
</style>

@code {
    private bool isLoading = true;
    private bool isAuthenticated = false;
    private string userName = "";
    private string userEmail = "";
    private string userId = "";
    private DateTime? creationDate = null;
    private List<string> userRoles = new();
    
    // Denne simulerede login er kun til demonstration
    private bool simulatedLogin = false;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadUserData();
    }
    
    private async Task LoadUserData()
    {
        isLoading = true;
        
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            isAuthenticated = user.Identity?.IsAuthenticated == true || simulatedLogin;
            
            if (isAuthenticated)
            {
                if (simulatedLogin)
                {
                    // Simuler brugerdata til demonstrationsformål
                    userName = "Anders Andersen";
                    userEmail = "anders@example.com";
                    userId = "user-12345";
                    creationDate = DateTime.Now.AddDays(-120);
                    userRoles = new List<string> { "User", "Editor" };
                }
                else
                {
                    // Få data fra aktuelle claims (i en rigtig applikation)
                    userName = user.FindFirst(ClaimTypes.Name)?.Value ?? "Unavailable";
                    userEmail = user.FindFirst(ClaimTypes.Email)?.Value ?? "No email available";
                    userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "Unknown";
                    
                    // Prøv at få oprettelsesdato (hvis tilgængelig)
                    var dateCreatedClaim = user.FindFirst("DateCreated");
                    if (dateCreatedClaim != null && DateTime.TryParse(dateCreatedClaim.Value, out var date))
                    {
                        creationDate = date;
                    }
                    
                    // Find alle roller
                    userRoles = user.Claims
                        .Where(c => c.Type == ClaimTypes.Role)
                        .Select(c => c.Value)
                        .ToList();
                }
            }
        }
        catch (Exception)
        {
            // Håndter fejl her
            isAuthenticated = false;
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private string GetInitials(string name)
    {
        if (string.IsNullOrEmpty(name))
            return "?";
        
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        }
        
        return name.Length > 0 ? name[0].ToString().ToUpper() : "?";
    }
    
    private async Task SimulateLogin()
    {
        simulatedLogin = true;
        await LoadUserData();
    }
    
    private void GoBack()
    {
        NavigationManager.NavigateTo("/task/22");
    }
} 